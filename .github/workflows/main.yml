name: Deploy to ECR

on:
 
  push:
    branches: [ master ]

jobs:
  
  build:
    
    name: Build Image
    runs-on: ubuntu-latest

   
    steps:

    - name: Check out code
      uses: actions/checkout@v2
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-2

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: weather-app
        IMAGE_TAG: weather-app
      run: |
        docker build -t 255484761797.dkr.ecr.eu-west-2.amazonaws.com/weather-app:${{ github.run_attempt }} .
        docker push 255484761797.dkr.ecr.eu-west-2.amazonaws.com/weather-app:${{ github.run_attempt }}
     
    - name: Scan Docker image
      id: docker-scan
      env: 
       TAG: ${{ github.run_attempt }}
      uses: alexjurkiewicz/ecr-scan-image@v1.7.0
      with:
        repository: 255484761797.dkr.ecr.eu-west-2.amazonaws.com/weather-app:$TAG
        tag: $TAG
        # fail_threshold: medium
        # ignore_list: |
        #   CVE-2014-7654321
        #   CVE-2014-456132
    # Access scan results in later steps
    - run: echo "${{ steps.docker-scan.outputs.total }} total vulnerabilities."
